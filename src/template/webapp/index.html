<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chakra - $APP_NAME$</title>
    <link rel="icon" href="/assets/logo.png" type="image/png">
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Chakra Dev Bar */
        .chakra-dev-bar {
            background-color: #1e1e2e;
            color: #ffffff;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .chakra-dev-bar.collapsed {
            height: 0.5rem;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
        }

        .chakra-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chakra-logo img {
            width: 28px;
            height: 28px;
        }

        .chakra-actions {
            display: flex;
            gap: 1rem;
        }

        .chakra-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chakra-status.success {
            color: #50fa7b;
        }

        .chakra-status.error {
            color: #ff5555;
        }

        .chakra-status.info {
            color: #8be9fd;
        }

        .chakra-toggler {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border: 1px solid #45475a;
            border-radius: 4px;
            background-color: #313244;
            color: #cdd6f4;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .chakra-toggler:hover {
            background-color: #45475a;
        }

        /* App Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #app {
            flex: 1;
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        /* Dev Console */
        .dev-console {
            background-color: rgba(0, 0, 0, 0.85);
            border-top: 1px solid #313244;
            color: #f8f8f2;
            font-family: monospace;
            font-size: 0.9rem;
            height: 200px;
            overflow: auto;
            padding: 0.5rem;
            display: none;
        }

        .dev-console.visible {
            display: block;
        }

        .dev-console .info {
            color: #8be9fd;
        }

        .dev-console .error {
            color: #ff5555;
        }

        .dev-console .warning {
            color: #f1fa8c;
        }

        /* Loading Indicator */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }

        /* Resource Timer */
        .resource-timer {
            font-size: 0.8rem;
            color: #6272a4;
            margin-left: 1rem;
        }
    </style>
</head>
<body>
    <!-- Chakra Dev Bar -->
    <div class="chakra-dev-bar" id="chakra-dev-bar">
        <div class="chakra-logo">
            <img src="/assets/logo.png" alt="Chakra Logo">
            <span><strong>Chakra</strong></span>
        </div>
        <div class="chakra-status info" id="chakra-status">
            <span class="loading-indicator"></span>
            <span>Loading application...</span>
        </div>
        <div class="chakra-actions">
            <button class="chakra-toggler" id="console-toggle">
                <span>üñ•Ô∏è</span> Console
            </button>
            <button class="chakra-toggler" id="bar-toggle">
                <span>‚¨ÜÔ∏è</span> Hide
            </button>
        </div>
    </div>

    <!-- Application Container -->
    <div class="app-container">
        <div id="app"></div>
        <div class="dev-console" id="dev-console"></div>
    </div>

    <script>
        // Chakra Dev Tools
        (function() {
            // Setup toggles
            const barToggle = document.getElementById('bar-toggle');
            const consoleToggle = document.getElementById('console-toggle');
            const devBar = document.getElementById('chakra-dev-bar');
            const devConsole = document.getElementById('dev-console');
            
            // Toggle dev bar
            barToggle.addEventListener('click', () => {
                devBar.classList.toggle('collapsed');
                barToggle.innerHTML = devBar.classList.contains('collapsed') 
                    ? '<span>‚¨áÔ∏è</span> Show' 
                    : '<span>‚¨ÜÔ∏è</span> Hide';
            });
            
            // Toggle console
            consoleToggle.addEventListener('click', () => {
                devConsole.classList.toggle('visible');
            });
            
            // Console logging override
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            function addLogToConsole(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = type;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                devConsole.appendChild(logEntry);
                devConsole.scrollTop = devConsole.scrollHeight;
            }
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                addLogToConsole(args.join(' '), 'info');
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                addLogToConsole(args.join(' '), 'error');
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                addLogToConsole(args.join(' '), 'warning');
            };
            
            // Status update function
            window.updateChakraStatus = function(message, type = 'info') {
                const statusEl = document.getElementById('chakra-status');
                statusEl.className = `chakra-status ${type}`;
                statusEl.innerHTML = `<span>${message}</span>`;
            };
            
            // Resource loading timer
            const startTime = performance.now();
            window.addEventListener('load', () => {
                const loadTime = Math.round(performance.now() - startTime);
                const statusEl = document.getElementById('chakra-status');
                
                if (!statusEl.classList.contains('error')) {
                    statusEl.innerHTML += `<span class="resource-timer">(${loadTime}ms)</span>`;
                }
            });

            // Live reload support
            function setupLiveReload() {
                let reloadInterval = null;
                let lastReloadTime = 0;
                
                // Poll the server for reload events
                function startPolling() {
                    if (reloadInterval) return;
                    
                    reloadInterval = setInterval(() => {
                        fetch('/reload', { cache: 'no-store' })
                        .then(response => {
                            if (response.headers.get('X-Reload') === 'true') {
                                // Prevent multiple reloads in quick succession
                                const now = Date.now();
                                if (now - lastReloadTime < 2000) return;
                                
                                lastReloadTime = now;
                                console.log("üîÑ Change detected - reloading application...");
                                
                                // Stop polling during reload
                                clearInterval(reloadInterval);
                                reloadInterval = null;
                                
                                window.updateChakraStatus('Reloading application...', 'info');
                                
                                // Reload the page after a short delay
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500);
                            }
                        })
                        .catch(e => {
                            // Ignore errors - server might be restarting
                        });
                    }, 1000);
                }
                
                // Start polling
                startPolling();
                
                // Listen for visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        console.log("Tab is visible again - checking for updates...");
                        startPolling();
                    } else {
                        clearInterval(reloadInterval);
                        reloadInterval = null;
                    }
                });
                
                // Handle window unload
                window.addEventListener('beforeunload', () => {
                    clearInterval(reloadInterval);
                });
            }

            // Initialize live reload
            setupLiveReload();
        })();
    </script>

    <!-- App Initialization -->
    <script type="module">
        // Import the application
        import init from '$JS_ENTRYPOINT$';
        
        async function startApp() {
            try {
                console.log("Initializing Rust web application...");
                
                // Initialize the application
                // Some frameworks expect options (like a target element)
                await init({
                    target: document.getElementById('app')
                }).catch(e => {
                    // If initialization with options fails, try without options
                    if (e.message.includes("isn't a function")) {
                        console.log("Trying initialization without options...");
                        return init();
                    }
                    throw e;
                });
                
                // Update status on success
                window.updateChakraStatus('Application loaded successfully ‚úÖ', 'success');
                console.log("Rust web application initialized successfully!");
            } catch (error) {
                // Handle errors during initialization
                window.updateChakraStatus(`Error loading application ‚ùå`, 'error');
                console.error("Failed to initialize application:", error);
                
                // Show error in app container
                document.getElementById('app').innerHTML = `
                    <div style="padding: 2rem; color: #ff5555; max-width: 800px; margin: 2rem auto; border: 1px solid #ff5555; border-radius: 8px;">
                        <h2>Application Failed to Load</h2>
                        <p>There was an error initializing the Rust application:</p>
                        <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 4px; overflow: auto;">${error.message}</pre>
                        <p style="margin-top: 1rem;">Check the browser console for more details.</p>
                    </div>
                `;
            }
        }
        
        // Start the application
        startApp();
    </script>
</body>
</html>
